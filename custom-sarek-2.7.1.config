/*
 * -------------------------------------------------
 *  nf-core/sarek Nextflow config file
 * -------------------------------------------------
 * Default config options for all environments.
 */


plugins {
    id 'nf-amazon'
}

// Global default params, used in configs
params {
  // Workflow flags:

  // Mandatory arguments
  input = null // No default input
  step = 'mapping' // Starts with mapping

  // Genome and references options
  genome = 'GRCh38'
  igenomes_base = '/mnt/efs/amak/s3/data/public/pipeline/igenomes'
  igenomes_ignore = false
  bwa = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Sequence/BWAIndex/Homo_sapiens_assembly38.fasta.64.{alt,amb,ann,bwt,pac,sa}'
  dict = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Sequence/WholeGenomeFasta/Homo_sapiens_assembly38.dict'
  fasta = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Sequence/WholeGenomeFasta/Homo_sapiens_assembly38.fasta'
  fasta_fai = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Sequence/WholeGenomeFasta/Homo_sapiens_assembly38.fasta.fai'
  intervals = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Annotation/intervals/wgs_calling_regions.hg38.bed'
  known_indels = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Annotation/GATKBundle/{Mills_and_1000G_gold_standard.indels.hg38,beta/Homo_sapiens_assembly38.known_indels}.vcf.gz'
  known_indels_index = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Annotation/GATKBundle/{Mills_and_1000G_gold_standard.indels.hg38,beta/Homo_sapiens_assembly38.known_indels}.vcf.gz.tbi'
  
  germline_resource = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz'
  germline_resource_index = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Annotation/GermlineResource/gnomAD.r2.1.1.GRCh38.PASS.AC.AF.only.vcf.gz.tbi'
  dbsnp  = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Annotation/GATKBundle/dbsnp_146.hg38.vcf.gz'
  dbsnp_index = '/mnt/efs/amak/s3/data/public/pipeline/igenomes/Homo_sapiens/GATK/GRCh38/Annotation/GATKBundle/dbsnp_146.hg38.vcf.gz.tbi'

  // *****
  target_bed = '/mnt/efs/amak/s3/data/public/pipeline/exome_bed/Twist_Exome_2.0.2_plus_Comprehensive_Exome_Spike-in/hg38_Twist_Exome_2.0.2_plus_Comprehensive_Exome_Spike-in_targets_sorted.annotated.bed' // No default TargetBED file for targeted sequencing
  read_orientation_bias_model = true

  // Modify fastqs (trim/split)
  trim_fastq = true // No trimming

  // Preprocessing
  // aligner = 'bwa-mem'
  markdup_java_options = '"-Xms4000m -Xmx7g"' // Established values for markDuplicates memory consumption, see https://github.com/SciLifeLab/Sarek/pull/689 for details
  // Expect warnings
  default_java_xmx_gb = 7
  default_java_xmx_gb_qualimap = 200

  // Variant Calling
  cf_window = 0                   // by default we are not using this in Control-FREEC
  pon = '/mnt/efs/amak/s3/data/public/pipeline/gatk-best-practices/somatic-hg38/1000g_pon.hg38.vcf.gz' // No default PON (Panel of Normals) file for GATK Mutect2 / Sentieon TNscope
  pon_index = '/mnt/efs/amak/s3/data/public/pipeline/gatk-best-practices/somatic-hg38/1000g_pon.hg38.vcf.gz.tbi' // No default PON index for GATK Mutect2 / Sentieon TNscope
  
  // For PureCN
  // mutect2_args = '--genotype-germline-sites true --genotype-pon-sites true'
  
  // Annotation

  // Other options
  // outdir = './results'

  // Base specifications
  // Defaults only, expecting to be overwritten
  cpus = 60
  max_cpus = 60
  max_memory = 500.GB
  max_time = 336.h
  single_cpu_mem = 7.GB
}

env {
  // NXF_OPTS='-Xms1g'
  NXF_OPTS='-Xms1g -Xmx10g'
}

executor {
  name = 'slurm'
  // next try 40
  queueSize = 40 // The number of tasks the executor will handle in a parallel manner (default: 100).
  // set this too slow is bad for short tasks like ApplyBQSR but good for long jobs
  submitRateLimit = '1/5 sec' // Determines the max rate of job submission per time unit, 10 sec (max 10 job per sec), 1/10sec=1 per 10 sec
  exitReadTimeout = '13 min' // Determines how long the executor waits before to an error status when a process is terminated but the .exitcode file does not exist or is empty. This setting is used only by grid executors (default: 270 sec).
}

process {
    
    cache = 'lenient'
    
    //****************************************
    // Defaults
    //****************************************
    
    // errorStrategy = 'retry'
    // terminate vs finish
    errorStrategy = { task.exitStatus in [143,137,104,134,139,247] ? 'retry' : 'finish' }
    maxRetries    = 3
    maxErrors     = '-1'
    
    // retry.maxAttempts = 3 // default 3
    retry.maxAttempts = 3 // default 3
    
    // scratch = '/mnt/efs/amak/tmp'
    

    cpus = 1
    memory = ''
    clusterOptions = '--partition low'
    
    // In order to set a default configuration
    // Uncomment this line
    // clusterOptions = '--partition basic  --constraint t32xlarge'

    //****************************************
    // Nextflow Default Labels
    //****************************************

    
    withLabel:process_tiny {
        // mem = 6
        cpus = 1
        memory = ''
        clusterOptions = '--partition low'
    }
    
    withLabel:process_low {
        cpus = 2
        memory = ''
        clusterOptions = '--partition low'
    }
    
    withLabel:process_medium {
        cpus = 6
        memory = ''
        clusterOptions = '--partition medium'
    }
    
    withLabel:process_high {
        cpus = 12
        memory = ''
        clusterOptions = '--partition high'
    }
    
    withLabel:process_high_memory {
        // mem = 200
        cpus = 12
        memory = ''
        clusterOptions = '--partition memory'
    }
    
    withLabel:process_long {
        memory = ''
        clusterOptions = '--partition low'
    }
    
    
    withLabel:memory_singleCPU_2_task {
        memory = ''
        clusterOptions = '--partition low'
    }
    withLabel:memory_singleCPU_task_sq {
        memory = ''
        clusterOptions = '--partition low'
    }
    withLabel:memory_max {
        cpus = 32
        memory = ''
        clusterOptions = '--partition memory'
    }
    
    withLabel:cpus_1 {
      memory = ''
      clusterOptions = '--partition low'
    }
    withLabel:cpus_2 {
      memory = ''
      clusterOptions = '--partition low'
    }
    withLabel:cpus_4 {
      memory = ''
      clusterOptions = '--partition low'
    }
    withLabel:cpus_8 {
      memory = ''
      clusterOptions = '--partition medium'
    }
    withLabel:cpus_16 {
      memory = ''
      clusterOptions = '--partition medium'
    }
    
    withLabel:cpus_max {
      memory = ''
      clusterOptions = '--partition high'
    }
    
    
    // must be 2 because cannot run in parallel
    withName:TrimGalore {
      cpus = 2
      memory = ''
      time = '12.h'
      clusterOptions = '--partition medium'
    }
    
    withName:FastQCFQ {
      cpus = 6
      memory = ''
      clusterOptions = '--partition medium'
    }
    
    // cpus_max
    withName:MapReads {
      cpus = 40
      memory = ''
      clusterOptions = '--partition high'
    }
    
    
    // MarkDuplicates : 5 cpu, 15 GB; label 'cpus_16', see markdup_java_options = '"-Xms4000m -Xmx7g"'
    
    
}